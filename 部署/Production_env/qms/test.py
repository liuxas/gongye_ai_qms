import requests
import json
from pdb import set_trace

def process_specification(pdf_file_path, spec_data):
    """
    调用处理规格表的API
    
    Args:
        pdf_file_path: PDF文件路径
        spec_data: 规格表数据列表
    
    Returns:
        dict: API响应结果
    """
    # API端点
    url = "http://localhost:5008/api/file/extract-fields"
    
    # 准备请求数据
    files = {
        'file': open(pdf_file_path, 'rb')
    }
    
    data = {
        'dataList': json.dumps(spec_data, ensure_ascii=False)
    }
    
    try:
        # 发送POST请求
        response = requests.post(url, files=files, data=data)
        
        # 检查响应状态
        if response.status_code == 200:
            result = response.json()
            if result.get('success'):
                print("处理成功！")
                return result
            else:
                print(f"处理失败: {result.get('message')}")
                return result
        else:
            print(f"请求失败，状态码: {response.status_code}")
            print(f"错误信息: {response.text}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"网络请求错误: {e}")
        return None
    except Exception as e:
        print(f"其他错误: {e}")
        return None
    finally:
        # 确保文件被关闭
        if 'file' in files:
            files['file'].close()

# 示例用法
if __name__ == "__main__":
    # 示例规格表数据
    spec_data = [{'项目代码': 'A001', '检验项目': '球标1', '类型': '定量', '上限': '653', '下限': '647', '单位': 'MM'},
                {'项目代码': 'A002', '检验项目': '球标2', '类型': '定量', '上限': '653', '下限': '647', '单位': 'MM'}, 
                {'项目代码': 'A003', '检验项目': '球标3', '类型': '定量', '上限': '619', '下限': '613', '单位': 'MM'}, 
                {'项目代码': 'A004', '检验项目': '球标4', '类型': '定量', '上限': '482', '下限': '478', '单位': 'MM'}, 
                {'项目代码': 'A005', '检验项目': '球标5', '类型': '定量', '上限': '482', '下限': '478', '单位': 'MM'}, 
                {'项目代码': 'A006', '检验项目': '球标6', '类型': '定量', '上限': '444', '下限': '440', '单位': 'MM'}, 
                {'项目代码': 'A007', '检验项目': '球标7', '类型': '定量', '上限': '317', '下限': '313', '单位': 'MM'}, 
                {'项目代码': 'A008', '检验项目': '球标8', '类型': '定量', '上限': '8.5', '下限': '6.5', '单位': 'MM'}, 
                {'项目代码': 'A009', '检验项目': '球标9', '类型': '定量', '上限': '621', '下限': '615', '单位': 'MM'}, 
                {'项目代码': 'A010', '检验项目': '球标10', '类型': '定量', '上限': '446', '下限': '442', '单位': 'MM'}, 
                {'项目代码': 'A011', '检验项目': '球标11', '类型': '定量', '上限': '1', '下限': '-1', '单位': 'MM'}, 
                {'项目代码': 'A012', '检验项目': '表面静电阻抗1', '类型': '定量', '上限': '1000000000', '下限': '100000', '单位': 'ohm-cm'}, 
                {'项目代码': 'A013', '检验项目': '表面静电阻抗2', '类型': '定量', '上限': '1000000000', '下限': '100000', '单位': 'ohm-cm'}, 
                {'项目代码': 'A014', '检验项目': '表面静电阻抗3', '类型': '定量', '上限': '1000000000', '下限': '100000', '单位': 'ohm-cm'},
                  {'项目代码': 'A015', '检验项目': '表面静电阻抗4', '类型': '定量', '上限': '1000000000', '下限': '100000', '单位': 'ohm-cm'}, 
                  {'项目代码': 'A016', '检验项目': '表面静电阻抗5', '类型': '定量', '上限': '1000000000', '下限': '100000', '单位': 'ohm-cm'}, 
                  {'项目代码': 'A017', '检验项目': '重量（含插块）', '类型': '定量', '上限': '671', '下限': '573.4', '单位': 'G'}, 
                  {'项目代码': 'A018', '检验项目': '重量（不含插块）', '类型': '定量', '上限': '0.61', '下限': '0.53', '单位': 'KG'}, 
                  {'项目代码': 'A026', '检验项目': '球标12', '类型': '定量', '上限': '未找到', '下限': '未找到', '单位': 'MM'}, {
                      '项目代码': 'A027', '检验项目': '球标13', '类型': '定量', '上限': '未找到', '下限': '未找到', '单位': 'MM'}, 
                      {'项目代码': 'A028', '检验项目': '弯曲（产品边缘和平面间隙）', '类型': '定量', '上限': '3', '下限': '0', '单位': 'MM'}, 
                      {'项目代码': 'A029', '检验项目': '含水率', '类型': '定量', '上限': '20', '下限': '0', '单位': '%'}, 
                      {'项目代码': 'A020', '检验项目': '材质', '类型': '定性', '上限': '0.0', '下限': '0.0', '单位': '-'}, 
                      {'项目代码': 'A021', '检验项目': '颜色', '类型': '定性', '上限': '0.0', '下限': '0.0', '单位': '-'}, 
                      {'项目代码': 'A022', '检验项目': '插块', '类型': '定性', '上限': '0.0', '下限': '0.0', '单位': '-'}, 
                      {'项目代码': 'A023', '检验项目': '外观', '类型': '定性', '上限': '0.0', '下限': '0.0', '单位': '-'}, 
                      {'项目代码': 'A024', '检验项目': '包装外观、标签', '类型': '定性', '上限': '0.0', '下限': '0.0', '单位': '-'}, 
                      {'项目代码': 'A025', '检验项目': '料期确认≥1/2有效期', '类型': '定性', '上限': '0.0', '下限': '0.0', '单位': '-'}]
    
    # PDF文件路径
    pdf_file_path = "test_data/HKC_23.8（9100）寸EPS箱体规格承认书_范本_290205009100_PN238CT01-3_V4_20240829.pdf"  # 替换为实际的PDF文件路径
    
    # 调用API
    result = process_specification(pdf_file_path, spec_data)
    
    if result and result.get('success'):
        # 打印处理结果
        print("\n处理结果:")
        print(json.dumps(result['dataList'], ensure_ascii=False, indent=2))
        
        # 可选：保存结果到文件
        with open('processed_result.json', 'w', encoding='utf-8') as f:
            json.dump(result['dataList'], f, ensure_ascii=False, indent=2)
        print("结果已保存到 processed_result.json")
